---
title: "3. Linear Referencing"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{linear-referencing-03}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
library(SEQKoalaDataPipeline)
library(ggplot2)
library(dplyr)
```


## Linear referencing / dynamic segmentation

The linear referencing/ dynamic segmentation approach is used to relate
the line transects with the grid information and covariate layers. While
it can be used to derive outputs for the statistical model, the tables
generated by linear referencing itself could serve other purposes.

The toolbox for linear referencing in this package allows the user to
generate a "Route Event Layer" (also referred to as "Route Event Tables"
or "Route Table") that are the fundamental way which routes (i.e.
Transects) are represented in linear referencing.

In the linear referencing terminology, each transect is represented as a
"route". Each record in the "Route Event Layer" that stores the distance
from the start of a transect of where an "Event" occurred. An event can
be an intersection with a grid cell, or certain values within the
covariate layer. Using the `fcn_route_table` call, we can create a
"Route Event Layer" that records each "Event" and has a TransectID that
relates each event back to the transect concerned.

The function call creates a few new columns that records the attributes
of the event:

1.  FMEAS: the "From Measure", which is the distance from the start
    point of the transect where the event starts
2.  TMEAS: the "To Measure", which is the distance from the start point
    of the transect where the event ends
3.  Variable Name (e.g. GridID): the value of the event, in this case,
    the GridID of the grid cell this "Event" is describing
4.  Tlength: transect length
5.  lpercent: the percentage (proportion) of the transect that is
    covered by this event


```r
data_dir <- "M:\\Users\\uqfcho\\Documents\\seq-koala-monitoring\\working_data"
fcn_set_home_dir(data_dir)
table_sf_2020 <- fcn_line_transect_sf_2020()
fcn_set_grid_size(5000) # grid width/ height in meters, and generate grid in local environment
#> Simple feature collection with 1800 features and 1 field
#> Geometry type: POLYGON
#> Dimension:     XY
#> Bounding box:  xmin: 378280 ymin: 6862464 xmax: 558280 ymax: 7112464
#> Projected CRS: GDA2020 / MGA zone 56
#> First 10 features:
#>                          geometry  GridID
#> 1  POLYGON ((378280 6862464, 3...  5000_1
#> 2  POLYGON ((383280 6862464, 3...  5000_2
#> 3  POLYGON ((388280 6862464, 3...  5000_3
#> 4  POLYGON ((393280 6862464, 3...  5000_4
#> 5  POLYGON ((398280 6862464, 4...  5000_5
#> 6  POLYGON ((403280 6862464, 4...  5000_6
#> 7  POLYGON ((408280 6862464, 4...  5000_7
#> 8  POLYGON ((413280 6862464, 4...  5000_8
#> 9  POLYGON ((418280 6862464, 4...  5000_9
#> 10 POLYGON ((423280 6862464, 4... 5000_10
fishnet <- fcn_get_grid() # Retrieve grid from environment for plotting
bbox <- list(xlim = c(441430, 449400), ylim = c(6928706, 6936814), expand = F)
```


```r
route_table <- fcn_route_table(fishnet, table_sf_2020)
#> Warning: attribute variables are assumed to be spatially constant
#> throughout all geometries
head(route_table[route_table$lpercent < 0.5,c('TransectID', 'GridID', 'FMEAS', 'TMEAS', "Tlength", "lpercent")])
#>                     TransectID   GridID    FMEAS     TMEAS   Tlength
#> 2059   1000.0_7.2_SOL.20200330 5000_451 327.9339 602.86400 602.86400
#> 2140.1  1004.0_30_SOL.20200716  5000_92   0.0000  52.40427 807.06010
#> 2178.1  1008.0_10_SOL.20220713 5000_350   0.0000  40.18318 350.37409
#> 2180     1009.0_1_SOL.20220720 5000_201 104.9016 198.07069 198.07069
#> 2182     1009.0_5_SOL.20220720 5000_201   0.0000  18.96872  55.44367
#> 2198     1015.0_1_SOL.20220721 5000_277 722.4784 863.04113 863.04114
#>         lpercent
#> 2059   0.4560401
#> 2140.1 0.0649323
#> 2178.1 0.1146865
#> 2180   0.4703833
#> 2182   0.3421260
#> 2198   0.1628692
```

The results of the event route layer can be viewed by using
`fcn_locate_feature_from_route` which segments the line transects based
on the route event layer. This operation segments the line transects
many different small segments - it could be slow if the route event
layer is large, especially if applied to high-resolution grid cells or
route event layers of rasterized covariate layers (described below). In
many cases, the route event layer table itself is a sufficient spatial
representation of the linear referencing results, but only by doing this
step can we inspect the results visually.

Here, we see that the line transects are successfully segmented at the
border of the grid cells, as colored by different ID numbers of the Grid
where transects are colored by the last digit of the GridID:


```r
route_features <- fcn_locate_feature_from_route(route_table, table_sf_2020)
ggplot() +
  geom_sf(data = fishnet, color = 'gray50', fill = 'gray80') +
  geom_sf(data = route_features, aes(color = substr(GridID, nchar(GridID), nchar(GridID))), linewidth = 1) +
  do.call(coord_sf, bbox) +
  scale_color_brewer(palette = "Set3") +
  labs(color = "") +
  #guides(color = 'none')+
  theme_bw()+
  theme(panel.grid = element_blank())
```

<div class="figure">
<img src="figure/unnamed-chunk-4-1.png" alt="plot of chunk unnamed-chunk-4" width="100%" />
<p class="caption">plot of chunk unnamed-chunk-4</p>
</div>
