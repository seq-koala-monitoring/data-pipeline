---
title: "4. Covariate extraction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{v04-covariates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
library(SEQKoalaDataPipeline)
library(dplyr)
library(ggplot2)
library(tidyterra)
library(patchwork)
```

Get data

```r
data_dir <- "M:\\Users\\uqfcho\\Documents\\seq-koala-monitoring\\working_data"
fcn_set_home_dir(data_dir)
table_sf_2020 <- fcn_line_transect_sf_2020()
fcn_set_grid_size(1000) # grid width/ height in meters, and generate grid in local environment
#> Simple feature collection with 43472 features and 1 field
#> Geometry type: POLYGON
#> Dimension:     XY
#> Bounding box:  xmin: 378280 ymin: 6862464 xmax: 554280 ymax: 7109464
#> Projected CRS: GDA2020 / MGA zone 56
#> First 10 features:
#>                          geometry  GridID
#> 1  POLYGON ((378280 6862464, 3...  1000_1
#> 2  POLYGON ((379280 6862464, 3...  1000_2
#> 3  POLYGON ((380280 6862464, 3...  1000_3
#> 4  POLYGON ((381280 6862464, 3...  1000_4
#> 5  POLYGON ((382280 6862464, 3...  1000_5
#> 6  POLYGON ((383280 6862464, 3...  1000_6
#> 7  POLYGON ((384280 6862464, 3...  1000_7
#> 8  POLYGON ((385280 6862464, 3...  1000_8
#> 9  POLYGON ((386280 6862464, 3...  1000_9
#> 10 POLYGON ((387280 6862464, 3... 1000_10
fishnet <- fcn_get_grid() # Retrieve grid from environment for plotting
```

# Covariate extraction

## Atemporal rasters covariate extraction

Likewise, the capabilities of linear referencing can be applied to
extract covariate information from Raster files. The raster layer can be
loaded using `fcn_covariate_raster_load`.


```r
cov <- fcn_covariate_raster_load("htele")
cov_route_table <- fcn_route_table_raster(cov, table_sf_2020)
terra::plot(cov)
```

<div class="figure">
<img src="fig-unnamed-chunk-3-1.png" alt="plot of chunk unnamed-chunk-3" width="100%" />
<p class="caption">plot of chunk unnamed-chunk-3</p>
</div>

The results of the linear referencing (route event layer) can be
inspected by using the same approach as above. Creation of the segments
could take a while. As seen in the outputs, the values of the event
layer (red) closely match that of the underlying raster layer (in blue).

```r
cov_route_table
#>               TransectID       Date   Tlength       htele      FMEAS
#> 1     1.0_0_SOL.20210810 2021-08-10  484.1095  98.1285629   39.51914
#> 2     1.0_0_SOL.20210810 2021-08-10  484.1095  90.8086243  128.43721
#> 3     1.0_0_SOL.20210810 2021-08-10  484.1095  93.5712357  167.95635
#> 4     1.0_0_SOL.20210810 2021-08-10  484.1095  87.7592163  276.63400
#> 5     1.0_0_SOL.20210810 2021-08-10  484.1095  90.6590424  296.39357
#> 6     1.0_0_SOL.20210810 2021-08-10  484.1095  99.3645401  434.71056
#> 7     1.0_1_SOL.20210810 2021-08-10  960.0208  86.4315948    0.00000
#> 8     1.0_1_SOL.20210810 2021-08-10  960.0208  94.0716553   78.36905
#> 9     1.0_1_SOL.20210810 2021-08-10  960.0208  99.3096390  156.73810
#> 10    1.0_1_SOL.20210810 2021-08-10  960.0208  99.5406876  215.51488
#> 11    1.0_1_SOL.20210810 2021-08-10  960.0208 101.6088638  313.47619
#> 12    1.0_1_SOL.20210810 2021-08-10  960.0208  97.9230270  352.66071
#> 13    1.0_1_SOL.20210810 2021-08-10  960.0208 108.7249451  470.21429
#> 14    1.0_1_SOL.20210810 2021-08-10  960.0208 111.2061310  607.36012
#> 15    1.0_1_SOL.20210810 2021-08-10  960.0208 117.2007904  626.95238
#> 16    1.0_1_SOL.20210810 2021-08-10  960.0208 111.9724274  744.50595
#> 17    1.0_1_SOL.20210810 2021-08-10  960.0208 104.6725388  783.69048
#> 18    1.0_1_SOL.20210810 2021-08-10  960.0208  96.8516769  862.05952
#> 19    1.0_1_SOL.20210810 2021-08-10  960.0208  92.3939438  940.42857
#> 20    1.0_2_SOL.20210810 2021-08-10 1306.0907  71.7607803    0.00000
#> 21    1.0_2_SOL.20210810 2021-08-10 1306.0907  83.0034027   79.96474
#> 22    1.0_2_SOL.20210810 2021-08-10 1306.0907  92.1838150  186.58439
#> 23    1.0_2_SOL.20210810 2021-08-10 1306.0907  93.7406082  239.89422
#> 24    1.0_2_SOL.20210810 2021-08-10 1306.0907 101.0420303  319.85895
#> 25    1.0_2_SOL.20210810 2021-08-10 1306.0907 105.0353088  399.82369
#> 26    1.0_2_SOL.20210810 2021-08-10 1306.0907 116.0385971  453.13352
#> 27    1.0_2_SOL.20210810 2021-08-10 1306.0907 120.4598312  559.75317
#> 28    1.0_2_SOL.20210810 2021-08-10 1306.0907 123.9467850  586.40808
#> 29    1.0_2_SOL.20210810 2021-08-10 1306.0907 114.2910233  693.02774
#> 30    1.0_2_SOL.20210810 2021-08-10 1306.0907 115.3687057  719.68265
#> 31    1.0_2_SOL.20210810 2021-08-10 1306.0907 110.0578995  826.30230
#> 32    1.0_2_SOL.20210810 2021-08-10 1306.0907 107.4120789  879.61213
#> 33    1.0_2_SOL.20210810 2021-08-10 1306.0907 107.4086914  959.57686
#> 34    1.0_2_SOL.20210810 2021-08-10 1306.0907  98.9368591 1039.54160
#> 35    1.0_2_SOL.20210810 2021-08-10 1306.0907  95.6661377 1092.85143
#> 36    1.0_2_SOL.20210810 2021-08-10 1306.0907  88.7159882 1199.47108
#> 37    1.0_2_SOL.20210810 2021-08-10 1306.0907  85.7147598 1226.12599
#> 38    1.0_3_SOL.20210810 2021-08-10  665.1105  80.0948181    0.00000
#> 39    1.0_3_SOL.20210810 2021-08-10  665.1105  88.8545303   13.57368
#> 40    1.0_3_SOL.20210810 2021-08-10  665.1105  93.9811478  122.16316
#> 41    1.0_3_SOL.20210810 2021-08-10  665.1105 102.3518906  149.31052
#> 42    1.0_3_SOL.20210810 2021-08-10  665.1105 106.1898575  271.47368
#> 43    1.0_3_SOL.20210810 2021-08-10  665.1105  99.7986832  407.21052
#> 44    1.0_3_SOL.20210810 2021-08-10  665.1105 101.6218491  434.35789
#> 45    1.0_3_SOL.20210810 2021-08-10  665.1105  94.3752136  542.94736
#> 46    1.0_3_SOL.20210810 2021-08-10  665.1105  99.0598907  583.66841
#> 47    1.0_3_SOL.20210810 2021-08-10  665.1105  96.2520752  665.11052
#> 48  1.0_3.1_SOL.20210810 2021-08-10  518.4226  86.2840576    0.00000
#> 49  1.0_3.1_SOL.20210810 2021-08-10  518.4226  91.2672501   10.58005
#> 50  1.0_3.1_SOL.20210810 2021-08-10  518.4226  95.0279312  137.54069
#> 51  1.0_3.1_SOL.20210810 2021-08-10  518.4226 103.5970840  264.50133
#> 52  1.0_3.1_SOL.20210810 2021-08-10  518.4226  95.5546646  296.24149
#> 53  1.0_3.1_SOL.20210810 2021-08-10  518.4226 101.0841370  402.04202
#> 54  1.0_3.1_SOL.20210810 2021-08-10  518.4226  96.2520752  444.36224
#> 55    1.0_4_SOL.20210811 2021-08-11  907.1461  98.0591354    0.00000
#> 56    1.0_4_SOL.20210811 2021-08-11  907.1461 107.7485046   55.53956
#> 57    1.0_4_SOL.20210811 2021-08-11  907.1461 109.8828049   74.05274
#> 58    1.0_4_SOL.20210811 2021-08-11  907.1461 108.9294434  185.13185
#> 59    1.0_4_SOL.20210811 2021-08-11  907.1461 102.2802887  240.67141
#> 60    1.0_4_SOL.20210811 2021-08-11  907.1461  96.5014954  314.72415
#> 61    1.0_4_SOL.20210811 2021-08-11  907.1461  90.4066086  388.77689
#> 62    1.0_4_SOL.20210811 2021-08-11  907.1461  87.9675293  444.31644
#> 63    1.0_4_SOL.20210811 2021-08-11  907.1461  86.4816208  555.39556
#> 64    1.0_4_SOL.20210811 2021-08-11  907.1461  82.5734329  573.90874
#> 65    1.0_4_SOL.20210811 2021-08-11  907.1461  80.6365051  703.50104
#> 66    1.0_4_SOL.20210811 2021-08-11  907.1461  81.7020645  833.09333
#> 67    1.0_4_SOL.20210811 2021-08-11  907.1461  81.4971085  851.60652
#> 68    1.0_5_SOL.20210811 2021-08-11  292.8276  83.1643143    0.00000
#> 69    1.0_5_SOL.20210811 2021-08-11  292.8276  83.9381943   41.83251
#> 70    1.0_5_SOL.20210811 2021-08-11  292.8276  86.2895508   47.80859
#> 71    1.0_5_SOL.20210811 2021-08-11  292.8276  97.8077011  185.25827
#> 72    2.0_0_SOL.20210914 2021-09-14  225.8871   4.9572058    0.00000
#> 73    2.0_0_SOL.20210914 2021-09-14  225.8871   4.6218963  110.63860
#> 74    2.0_0_SOL.20210914 2021-09-14  225.8871   5.2267113  165.95790
#> 75    2.0_1_SOL.20210914 2021-09-14  392.3073   3.0290339    0.00000
#> 76    2.0_1_SOL.20210914 2021-09-14  392.3073   5.6569290   64.05017
#> 77    2.0_1_SOL.20210914 2021-09-14  392.3073   6.3112888   80.06271
#> 78    2.0_1_SOL.20210914 2021-09-14  392.3073   8.0182619  184.14423
#> 79    2.0_1_SOL.20210914 2021-09-14  392.3073   5.8798933  272.21321
#> 80    2.0_1_SOL.20210914 2021-09-14  392.3073   4.4406481  304.23830
#> 81    2.0_2_SOL.20210914 2021-09-14  344.3980   3.9865353    0.00000
#> 82    2.0_2_SOL.20210914 2021-09-14  344.3980   8.5948601   56.22825
#> 83    2.0_2_SOL.20210914 2021-09-14  344.3980   9.6675453  133.54209
#> 84    2.0_2_SOL.20210914 2021-09-14  344.3980   7.3781419  168.68475
#> 85    2.0_2_SOL.20210914 2021-09-14  344.3980   4.1853876  288.16978
#> 86    2.0_2_SOL.20210914 2021-09-14  344.3980   2.2097247  323.31243
#> 87    2.0_3_SOL.20210914 2021-09-14  296.9057   2.5114830    0.00000
#> 88    2.0_3_SOL.20210914 2021-09-14  296.9057   4.9430017   66.65230
#> 89    2.0_3_SOL.20210914 2021-09-14  296.9057   8.1762438  169.66041
#> 90    2.0_3_SOL.20210914 2021-09-14  296.9057   5.2552466  181.77901
#> 91    2.0_4_SOL.20210914 2021-09-14  179.1759   1.4535773    0.00000
#> 92    2.0_4_SOL.20210914 2021-09-14  179.1759   4.3423104   10.96995
#> 93    2.0_4_SOL.20210914 2021-09-14  179.1759   6.1197081   87.75962
#> 94    2.0_4_SOL.20210914 2021-09-14  179.1759   4.8212657  131.63943
#> 95    2.0_5_SOL.20210914 2021-09-14  206.3492  -0.7057739    0.00000
#> 96    2.0_5_SOL.20210914 2021-09-14  206.3492   0.4129234   16.84483
#> 97    2.0_5_SOL.20210914 2021-09-14  206.3492   4.3536053   29.47846
#> 98    2.0_5_SOL.20210914 2021-09-14  206.3492   1.0084251  134.75867
#> 99    3.0_0_SOL.20210909 2021-09-09  180.5436  32.6337585    0.00000
#> 100   3.0_0_SOL.20210909 2021-09-09  180.5436  27.6040974   22.10738
#> 101   3.0_0_SOL.20210909 2021-09-09  180.5436  30.1229134  110.53691
#> 102   3.0_0_SOL.20210909 2021-09-09  180.5436  23.7343769  151.06711
#> 103   3.0_1_SOL.20210909 2021-09-09  327.4828  22.6150265    0.00000
#> 104   3.0_1_SOL.20210909 2021-09-09  327.4828  31.5528126   26.73329
#> 105   3.0_1_SOL.20210909 2021-09-09  327.4828  34.4245682   93.56652
#> 106   3.0_1_SOL.20210909 2021-09-09  327.4828  39.4174995  173.76640
#> 107   3.0_1_SOL.20210909 2021-09-09  327.4828  38.0559692  233.91630
#> 108   3.0_1_SOL.20210909 2021-09-09  327.4828  40.9667587  314.11618
#> 109   3.0_2_SOL.20210909 2021-09-09  408.2218  42.2307625    0.00000
#> 110   3.0_2_SOL.20210909 2021-09-09  408.2218  39.0626488   74.97951
#> 111   3.0_2_SOL.20210909 2021-09-09  408.2218  33.7458687  141.62796
#> 112   3.0_2_SOL.20210909 2021-09-09  408.2218  26.4184132  208.27640
#> 113   3.0_2_SOL.20210909 2021-09-09  408.2218  22.4088516  283.25591
#> 114   3.0_2_SOL.20210909 2021-09-09  408.2218  25.3462181  349.90436
#> 115   3.0_3_SOL.20210909 2021-09-09  676.7636  30.8695641    0.00000
#> 116   3.0_3_SOL.20210909 2021-09-09  676.7636  30.1957493   27.62300
#> 117   3.0_3_SOL.20210909 2021-09-09  676.7636  25.5982513   82.86901
#> 118   3.0_3_SOL.20210909 2021-09-09  676.7636  23.5042152  165.73803
#> 119   3.0_3_SOL.20210909 2021-09-09  676.7636  25.2146873  220.98404
#> 120   3.0_3_SOL.20210909 2021-09-09  676.7636  26.8431416  303.85305
#> 121   3.0_3_SOL.20210909 2021-09-09  676.7636  29.4027882  359.09906
#> 122   3.0_3_SOL.20210909 2021-09-09  676.7636  35.9262047  441.96808
#> 123   3.0_3_SOL.20210909 2021-09-09  676.7636  40.6534081  511.02559
#> 124   3.0_3_SOL.20210909 2021-09-09  676.7636  45.0115051  580.08310
#> 125   3.0_3_SOL.20210909 2021-09-09  676.7636  42.6118050  649.14062
#>          TMEAS segment_length   lpercent
#> 1    128.43721      88.918070 0.18367347
#> 2    167.95635      39.519142 0.08163265
#> 3    276.63400     108.677641 0.22448980
#> 4    296.39357      19.759571 0.04081633
#> 5    434.71056     138.316998 0.28571429
#> 6    484.10949      49.398928 0.10204082
#> 7     78.36905      78.369048 0.08163265
#> 8    156.73810      78.369048 0.08163265
#> 9    215.51488      58.776786 0.06122449
#> 10   313.47619      97.961309 0.10204082
#> 11   352.66071      39.184524 0.04081633
#> 12   470.21429     117.553571 0.12244898
#> 13   607.36012     137.145833 0.14285714
#> 14   626.95238      19.592262 0.02040816
#> 15   744.50595     117.553571 0.12244898
#> 16   783.69048      39.184524 0.04081633
#> 17   862.05952      78.369048 0.08163265
#> 18   940.42857      78.369048 0.08163265
#> 19   960.02083      19.592262 0.02040816
#> 20    79.96474      79.964739 0.06122449
#> 21   186.58439     106.619652 0.08163265
#> 22   239.89422      53.309826 0.04081633
#> 23   319.85895      79.964739 0.06122449
#> 24   399.82369      79.964739 0.06122449
#> 25   453.13352      53.309826 0.04081633
#> 26   559.75317     106.619652 0.08163265
#> 27   586.40808      26.654913 0.02040816
#> 28   693.02774     106.619652 0.08163265
#> 29   719.68265      26.654913 0.02040816
#> 30   826.30230     106.619652 0.08163265
#> 31   879.61213      53.309826 0.04081633
#> 32   959.57686      79.964739 0.06122449
#> 33  1039.54160      79.964739 0.06122449
#> 34  1092.85143      53.309826 0.04081633
#> 35  1199.47108     106.619652 0.08163265
#> 36  1226.12599      26.654913 0.02040816
#> 37  1306.09073      79.964739 0.06122449
#> 38    13.57368      13.573684 0.02040816
#> 39   122.16316     108.589472 0.16326531
#> 40   149.31052      27.147368 0.04081633
#> 41   271.47368     122.163156 0.18367347
#> 42   407.21052     135.736840 0.20408163
#> 43   434.35789      27.147368 0.04081633
#> 44   542.94736     108.589472 0.16326531
#> 45   583.66841      40.721052 0.06122449
#> 46   665.11052      81.442104 0.12244898
#> 47   665.11052       0.000000 0.00000000
#> 48    10.58005      10.580053 0.02040816
#> 49   137.54069     126.960639 0.24489796
#> 50   264.50133     126.960639 0.24489796
#> 51   296.24149      31.740160 0.06122449
#> 52   402.04202     105.800532 0.20408163
#> 53   444.36224      42.320213 0.08163265
#> 54   518.42261      74.060373 0.14285714
#> 55    55.53956      55.539556 0.06122449
#> 56    74.05274      18.513185 0.02040816
#> 57   185.13185     111.079111 0.12244898
#> 58   240.67141      55.539556 0.06122449
#> 59   314.72415      74.052741 0.08163265
#> 60   388.77689      74.052741 0.08163265
#> 61   444.31644      55.539556 0.06122449
#> 62   555.39556     111.079111 0.12244898
#> 63   573.90874      18.513185 0.02040816
#> 64   703.50104     129.592296 0.14285714
#> 65   833.09333     129.592296 0.14285714
#> 66   851.60652      18.513185 0.02040816
#> 67   907.14607      55.539556 0.06122449
#> 68    41.83251      41.832513 0.14285714
#> 69    47.80859       5.976073 0.02040816
#> 70   185.25827     137.449687 0.46938776
#> 71   292.82759     107.569320 0.36734694
#> 72   110.63860     110.638599 0.48979592
#> 73   165.95790      55.319300 0.24489796
#> 74   225.88714      59.929241 0.26530612
#> 75    64.05017      64.050168 0.16326531
#> 76    80.06271      16.012542 0.04081633
#> 77   184.14423     104.081523 0.26530612
#> 78   272.21321      88.068981 0.22448980
#> 79   304.23830      32.025084 0.08163265
#> 80   392.30728      88.068981 0.22448980
#> 81    56.22825      56.228249 0.16326531
#> 82   133.54209      77.313843 0.22448980
#> 83   168.68475      35.142656 0.10204082
#> 84   288.16978     119.485029 0.34693878
#> 85   323.31243      35.142656 0.10204082
#> 86   344.39803      21.085593 0.06122449
#> 87    66.65230      66.652302 0.22448980
#> 88   169.66041     103.008103 0.34693878
#> 89   181.77901      12.118600 0.04081633
#> 90   296.90571     115.126703 0.38775510
#> 91    10.96995      10.969953 0.06122449
#> 92    87.75962      76.789668 0.42857143
#> 93   131.63943      43.879810 0.24489796
#> 94   179.17589      47.536461 0.26530612
#> 95    16.84483      16.844834 0.08163265
#> 96    29.47846      12.633626 0.06122449
#> 97   134.75867     105.280214 0.51020408
#> 98   206.34922      71.590545 0.34693878
#> 99    22.10738      22.107383 0.12244898
#> 100  110.53691      88.429530 0.48979592
#> 101  151.06711      40.530201 0.22448980
#> 102  180.54362      29.476510 0.16326531
#> 103   26.73329      26.733292 0.08163265
#> 104   93.56652      66.833229 0.20408163
#> 105  173.76640      80.199875 0.24489796
#> 106  233.91630      60.149906 0.18367347
#> 107  314.11618      80.199875 0.24489796
#> 108  327.48282      13.366646 0.04081633
#> 109   74.97951      74.979506 0.18367347
#> 110  141.62796      66.648449 0.16326531
#> 111  208.27640      66.648449 0.16326531
#> 112  283.25591      74.979506 0.18367347
#> 113  349.90436      66.648449 0.16326531
#> 114  408.22175      58.317393 0.14285714
#> 115   27.62300      27.623005 0.04081633
#> 116   82.86901      55.246010 0.08163265
#> 117  165.73803      82.869015 0.12244898
#> 118  220.98404      55.246010 0.08163265
#> 119  303.85305      82.869015 0.12244898
#> 120  359.09906      55.246010 0.08163265
#> 121  441.96808      82.869015 0.12244898
#> 122  511.02559      69.057512 0.10204082
#> 123  580.08310      69.057512 0.10204082
#> 124  649.14062      69.057512 0.10204082
#> 125  676.76362      27.623005 0.04081633
#>  [ reached 'max' / getOption("max.print") -- omitted 17750 rows ]
```



```r
cov_route_features <- fcn_locate_feature_from_route(cov_route_table, table_sf_2020)
bbox <- list(xlim = c(441430, 449400), ylim = c(6928706, 6936814), expand = F)
ext <- terra::ext(bbox$xlim[1], bbox$xlim[2], bbox$ylim[1], bbox$ylim[2])
cov_crop <- terra::crop(cov, ext)
limits <- terra::minmax(cov_crop)
rast_plot <- ggplot() +
  geom_spatraster(data = cov_crop) +
  do.call(coord_sf, bbox)+
  labs(fill = "") +
  ggtitle("htele: covariate raster") +
  scale_fill_viridis_c(limits = c(limits[1], limits[2])) +
  #guides(color = 'none')+
  theme_bw()+
  theme(panel.grid = element_blank())
transect_plot <- ggplot() +
  geom_sf(data = cov_route_features, aes(color = htele), linewidth = 1) +
  do.call(coord_sf, bbox)+
  ggtitle("htele: extracted from transects") +
  labs(color = "") +
  scale_color_viridis_c(limits = c(limits[1], limits[2])) +
  theme_bw()+
  theme(panel.grid = element_blank())
rast_plot + transect_plot + plot_layout(guides = 'collect')
```

![plot of chunk htele_covariate](fig-htele_covariate-1.png)

## Spatio-temporal rasters

Extraction of covariates from spatio-temporal raster files are also
supported. The algorithm first extracts spatio-temporal rasters as a
multi-layer SpatRaster in `terra` and creates the Event Route Layer from
all spatio-temporal layers.


```r
cov_sptemp <- fcn_covariate_raster_load("hlwdy")
names(cov_sptemp)
#>  [1] "X199607" "X199707" "X199807" "X199907" "X200007" "X200107" "X200207"
#>  [8] "X200307" "X200407" "X200507" "X200607" "X200707" "X200807" "X200907"
#> [15] "X201007" "X201107" "X201207" "X201307" "X201407" "X201507" "X201607"
#> [22] "X201707" "X201807" "X201907"
```

The covariates are extracted as a multi-layer "SpatRaster" (from the
`terra` package) where the names of the raster layers represents the
dates of the raster layer. Where only the year and month of the raster
layers are available, the dates of the raster layers are assumed to be
taken on the 15th of the month. The date of the month is expected to
have a relatively small effect on the covariate extracted.


```r
cov_sptemp_route_table <- fcn_route_table_raster(cov_sptemp, table_sf_2020)
```

The covariate value of the route event layer can be matched to the date
of the survey. The covariate value representative of the date which the
transect is surveyed can be interpolated by the following methods:

-   bilinear: bilinear interpolation between the two closest dates of
    the survey date, weighted by how close the survey is to the two
    dates. If the survey date is earlier or later than all of the dates
    of the covariate layers, then the earliest or latest covariate layer
    is selected respectively

-   nearest: the covariate layer closest to the survey date is used

-   "lag1" / "lag2" / "lag3" (work in progress): lagged layers -- select
    the first, second or third layer available earlier than the survey
    date. If the lagged layer is not available, then select the earliest
    layer available.


```r
route_table_date_matched <- fcn_covariate_match_date(cov_sptemp_route_table, names(cov_sptemp), method = 'bilinear')
route_table_date_matched
#>            TransectID       Date   Tlength X199607 X199707 X199807 X199907
#> 1  1.0_0_SOL.20210810 2021-08-10  484.1095     161     164     166     166
#> 2  1.0_0_SOL.20210810 2021-08-10  484.1095     163     166     167     168
#> 3  1.0_0_SOL.20210810 2021-08-10  484.1095     159     160     162     164
#> 4  1.0_0_SOL.20210810 2021-08-10  484.1095     160     162     164     166
#> 5  1.0_0_SOL.20210810 2021-08-10  484.1095     163     167     168     170
#> 6  1.0_0_SOL.20210810 2021-08-10  484.1095     162     164     164     164
#> 7  1.0_1_SOL.20210810 2021-08-10  960.0208     159     160     162     163
#> 8  1.0_1_SOL.20210810 2021-08-10  960.0208     157     160     162     162
#> 9  1.0_1_SOL.20210810 2021-08-10  960.0208     156     157     159     160
#> 10 1.0_1_SOL.20210810 2021-08-10  960.0208     155     154     154     154
#> 11 1.0_1_SOL.20210810 2021-08-10  960.0208     166     168     170     172
#> 12 1.0_1_SOL.20210810 2021-08-10  960.0208     166     168     169     170
#> 13 1.0_1_SOL.20210810 2021-08-10  960.0208     157     157     159     160
#> 14 1.0_1_SOL.20210810 2021-08-10  960.0208     152     152     151     152
#> 15 1.0_1_SOL.20210810 2021-08-10  960.0208     156     156     156     156
#> 16 1.0_1_SOL.20210810 2021-08-10  960.0208     160     160     158     156
#> 17 1.0_1_SOL.20210810 2021-08-10  960.0208     164     164     163     162
#> 18 1.0_1_SOL.20210810 2021-08-10  960.0208     163     163     161     160
#> 19 1.0_1_SOL.20210810 2021-08-10  960.0208     160     161     160     159
#> 20 1.0_2_SOL.20210810 2021-08-10 1306.0907     161     162     162     160
#> 21 1.0_2_SOL.20210810 2021-08-10 1306.0907     164     163     161     161
#> 22 1.0_2_SOL.20210810 2021-08-10 1306.0907     169     167     165     162
#> 23 1.0_2_SOL.20210810 2021-08-10 1306.0907     167     168     168     168
#> 24 1.0_2_SOL.20210810 2021-08-10 1306.0907     164     162     161     161
#> 25 1.0_2_SOL.20210810 2021-08-10 1306.0907     160     161     162     163
#> 26 1.0_2_SOL.20210810 2021-08-10 1306.0907     159     159     160     162
#> 27 1.0_2_SOL.20210810 2021-08-10 1306.0907     162     162     163     163
#> 28 1.0_2_SOL.20210810 2021-08-10 1306.0907     160     161     162     162
#> 29 1.0_2_SOL.20210810 2021-08-10 1306.0907     159     158     157     157
#> 30 1.0_2_SOL.20210810 2021-08-10 1306.0907     151     151     151     152
#> 31 1.0_2_SOL.20210810 2021-08-10 1306.0907     152     152     151     150
#>    X200007 X200107 X200207 X200307 X200407 X200507 X200607 X200707 X200807
#> 1      165     164     164     164     163     163     162     162     163
#> 2      168     169     171     172     169     165     161     158     158
#> 3      166     167     169     170     169     164     158     156     159
#> 4      167     168     169     169     167     163     158     155     157
#> 5      170     171     171     171     168     165     161     159     161
#> 6      164     165     165     165     164     160     156     153     154
#> 7      164     165     163     160     157     154     153     153     156
#> 8      162     160     160     161     159     157     153     152     153
#> 9      161     162     162     161     160     158     156     155     156
#> 10     154     156     157     159     159     157     153     150     150
#> 11     173     173     173     170     167     165     162     159     161
#> 12     171     172     172     173     172     168     163     160     161
#> 13     163     165     166     167     165     161     157     154     156
#> 14     153     155     158     160     160     157     154     151     152
#> 15     156     156     158     158     158     157     157     155     156
#> 16     155     155     156     158     158     158     157     156     158
#> 17     161     161     161     163     163     163     162     160     162
#> 18     160     160     161     162     161     160     158     158     159
#> 19     160     160     163     163     163     161     158     158     159
#> 20     159     159     160     161     162     161     160     160     161
#> 21     160     161     163     164     164     162     158     155     156
#> 22     161     162     163     165     164     162     159     157     158
#> 23     167     167     167     167     166     164     161     159     161
#> 24     161     163     164     165     166     164     160     156     157
#> 25     164     164     164     165     162     159     157     157     158
#> 26     164     166     167     166     164     161     157     154     155
#> 27     163     163     163     163     162     160     157     155     157
#> 28     162     162     160     159     157     155     153     152     152
#> 29     159     159     159     159     158     156     153     152     152
#> 30     154     157     159     160     159     156     153     151     150
#> 31     151     151     152     152     153     152     150     147     146
#>    X200907 X201007 X201107 X201207 X201307 X201407 X201507 X201607 X201707
#> 1      166     170     172     172     171     168     164     161     161
#> 2      162     166     169     169     168     165     164     163     164
#> 3      167     173     176     174     169     164     161     161     163
#> 4      164     170     174     173     169     165     163     162     163
#> 5      165     171     174     174     170     166     163     162     163
#> 6      158     164     172     176     175     171     164     157     151
#> 7      160     164     165     164     161     159     156     155     157
#> 8      157     161     164     163     160     157     154     152     153
#> 9      160     163     166     165     163     159     156     153     154
#> 10     153     158     163     162     159     155     153     152     152
#> 11     165     171     176     178     174     170     167     165     165
#> 12     166     172     175     174     171     167     164     162     163
#> 13     162     168     171     172     170     166     161     155     150
#> 14     155     158     160     161     160     158     155     152     149
#> 15     158     160     163     162     162     160     157     154     152
#> 16     160     164     167     167     166     162     160     159     159
#> 17     163     167     170     169     165     161     160     160     162
#> 18     161     164     165     165     164     162     161     160     162
#> 19     162     165     168     168     164     161     160     160     160
#> 20     162     165     167     165     163     159     158     159     160
#> 21     159     164     168     169     168     166     164     163     162
#> 22     163     167     170     170     167     165     164     164     165
#> 23     165     170     172     172     171     168     166     163     162
#> 24     161     165     168     168     167     164     163     161     161
#> 25     159     161     162     161     162     161     162     163     163
#> 26     159     163     166     166     165     162     158     155     156
#> 27     160     163     165     166     165     165     164     161     162
#> 28     155     158     161     162     161     160     157     155     155
#> 29     154     159     163     164     162     158     155     151     152
#> 30     151     152     153     154     154     153     151     147     147
#> 31     147     149     151     151     150     149     146     143     143
#>    X201807 X201907     FMEAS     TMEAS segment_length   lpercent value
#> 1      162     167  39.51914 128.43721       88.91807 0.18367347   167
#> 2      162     162 128.43721 167.95635       39.51914 0.08163265   162
#> 3      161     161 167.95635 276.63400      108.67764 0.22448980   161
#> 4      161     161 276.63400 296.39357       19.75957 0.04081633   161
#> 5      162     163 296.39357 434.71056      138.31700 0.28571429   163
#> 6      155     159 434.71056 484.10949       49.39893 0.10204082   159
#> 7      156     157   0.00000  78.36905       78.36905 0.08163265   157
#> 8      151     151  78.36905 156.73810       78.36905 0.08163265   151
#> 9      151     151 156.73810 215.51488       58.77679 0.06122449   151
#> 10     152     150 215.51488 313.47619       97.96131 0.10204082   150
#> 11     162     160 313.47619 352.66071       39.18452 0.04081633   160
#> 12     161     160 352.66071 470.21429      117.55357 0.12244898   160
#> 13     155     159 470.21429 607.36012      137.14583 0.14285714   159
#> 14     149     156 607.36012 626.95238       19.59226 0.02040816   156
#> 15     154     157 626.95238 744.50595      117.55357 0.12244898   157
#> 16     160     161 744.50595 783.69048       39.18452 0.04081633   161
#> 17     161     161 783.69048 862.05952       78.36905 0.08163265   161
#> 18     162     161 862.05952 940.42857       78.36905 0.08163265   161
#> 19     156     155 940.42857 960.02083       19.59226 0.02040816   155
#> 20     157     156   0.00000  79.96474       79.96474 0.06122449   156
#> 21     161     156  79.96474 186.58439      106.61965 0.08163265   156
#> 22     162     161 186.58439 239.89422       53.30983 0.04081633   161
#> 23     162     161 239.89422 319.85895       79.96474 0.06122449   161
#> 24     159     161 319.85895 399.82369       79.96474 0.06122449   161
#> 25     162     160 399.82369 453.13352       53.30983 0.04081633   160
#> 26     155     158 453.13352 559.75317      106.61965 0.08163265   158
#> 27     164     160 559.75317 586.40808       26.65491 0.02040816   160
#> 28     153     152 586.40808 693.02774      106.61965 0.08163265   152
#> 29     150     151 693.02774 719.68265       26.65491 0.02040816   151
#> 30     146     147 719.68265 826.30230      106.61965 0.08163265   147
#> 31     143     145 826.30230 879.61213       53.30983 0.04081633   145
#>  [ reached 'max' / getOption("max.print") -- omitted 17844 rows ]
```

The date matching algorithm creates / overwrites the "value" column in
the route_table as an output. Here we preview the extracted,
interpolated value next to the most recent layer of the spatio-temporal
raster.


```r
cov_sptemp_date_matched <- fcn_locate_feature_from_route(route_table_date_matched, table_sf_2020)
ext <- terra::ext(bbox$xlim[1], bbox$xlim[2], bbox$ylim[1], bbox$ylim[2])
cov_sptemp_crop <- terra::crop(cov_sptemp, ext)
limits <- terra::minmax(cov_sptemp_crop)
rast_sptemp_plot <- ggplot() +
  geom_spatraster(data = cov_sptemp_crop, aes(fill = X201907)) +
  do.call(coord_sf, bbox)+
  labs(fill = "") +
  ggtitle("hlwdy: 2019/07 woody \nvegetation cover") +
  scale_fill_viridis_c(limits = c(limits[1], limits[2])) +
  #guides(color = 'none')+
  theme_bw()+
  theme(panel.grid = element_blank())
transect_sptemp_plot <- ggplot() +
  geom_sf(data = cov_sptemp_date_matched, aes(color = value), linewidth = 1) +
  do.call(coord_sf, bbox)+
  ggtitle("hlwdy: transects (bilinear)") +
  labs(color = "") +
  scale_color_viridis_c(limits = c(limits[1], limits[2])) +
  theme_bw()+
  theme(panel.grid = element_blank())
rast_sptemp_plot + transect_sptemp_plot + plot_layout(guides = 'collect')
```

![plot of chunk hlwdy_plot](fig-hlwdy_plot-1.png)
