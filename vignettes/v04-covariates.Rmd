---
title: "4. Covariate extraction"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{v04-covariates}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
library(SEQKoalaDataPipeline)
library(dplyr)
library(ggplot2)
library(tidyterra)
library(patchwork)
```

Get data

```r
#data_dir <- "M:\\Users\\uqfcho\\Documents\\seq-koala-monitoring\\working_data"
data_dir <- "C:\\Users\\uqfcho\\Documents/seq-koala-monitoring/working_data"
fcn_set_home_dir(data_dir)
table_sf_2020 <- fcn_line_transect_sf_2020()
fcn_set_grid_size(1000) # grid width/ height in meters, and generate grid in local environment
#> class       : SpatRaster 
#> dimensions  : 247, 176, 1  (nrow, ncol, nlyr)
#> resolution  : 1000, 1000  (x, y)
#> extent      : 378280, 554280, 6862464, 7109464  (xmin, xmax, ymin, ymax)
#> coord. ref. : GDA2020 / MGA zone 56 (EPSG:7856) 
#> source(s)   : memory
#> name        : GridID 
#> min value   :      1 
#> max value   :  23970
fishnet <- fcn_get_grid() # Retrieve grid from environment for plotting
```

# Covariate extraction

## Atemporal rasters covariate extraction

Likewise, the capabilities of linear referencing can be applied to
extract covariate information from Raster files. The raster layer can be
loaded using `fcn_covariate_raster_load`.


```r
cov <- fcn_covariate_raster_load("htele")
cov_route_table <- fcn_route_table_raster(cov, table_sf_2020)
terra::plot(cov)
```

<div class="figure">
<img src="fig-unnamed-chunk-3-1.png" alt="plot of chunk unnamed-chunk-3" width="100%" />
<p class="caption">plot of chunk unnamed-chunk-3</p>
</div>

The results of the linear referencing (route event layer) can be
inspected by using the same approach as above. Creation of the segments
could take a while. As seen in the outputs, the values of the event
layer (red) closely match that of the underlying raster layer (in blue).

```r
head(cov_route_table)
#>           TransectID       Date  Tlength    htele     FMEAS    TMEAS segment_length   lpercent
#> 1 1.0_0_SOL.20210810 2021-08-10 484.1095 98.12614  39.51914 128.4372       88.91807 0.18367347
#> 2 1.0_0_SOL.20210810 2021-08-10 484.1095 90.80642 128.43721 167.9564       39.51914 0.08163265
#> 3 1.0_0_SOL.20210810 2021-08-10 484.1095 93.56960 167.95635 276.6340      108.67764 0.22448980
#> 4 1.0_0_SOL.20210810 2021-08-10 484.1095 87.75806 276.63400 296.3936       19.75957 0.04081633
#> 5 1.0_0_SOL.20210810 2021-08-10 484.1095 90.65868 296.39357 434.7106      138.31700 0.28571429
#> 6 1.0_0_SOL.20210810 2021-08-10 484.1095 99.36263 434.71056 484.1095       49.39893 0.10204082
```



```r
cov_route_features <- fcn_locate_feature_from_route(cov_route_table, table_sf_2020)
bbox <- list(xlim = c(441430, 449400), ylim = c(6928706, 6936814), expand = F)
ext <- terra::ext(bbox$xlim[1], bbox$xlim[2], bbox$ylim[1], bbox$ylim[2])
cov_crop <- terra::crop(cov, ext)
limits <- terra::minmax(cov_crop)
rast_plot <- ggplot() +
  geom_spatraster(data = cov_crop) +
  do.call(coord_sf, bbox)+
  labs(fill = "") +
  ggtitle("htele: covariate raster") +
  scale_fill_viridis_c(limits = c(limits[1], limits[2])) +
  #guides(color = 'none')+
  theme_bw()+
  theme(panel.grid = element_blank())
transect_plot <- ggplot() +
  geom_sf(data = cov_route_features, aes(color = htele), linewidth = 1) +
  do.call(coord_sf, bbox)+
  ggtitle("htele: extracted from transects") +
  labs(color = "") +
  scale_color_viridis_c(limits = c(limits[1], limits[2])) +
  theme_bw()+
  theme(panel.grid = element_blank())
rast_plot + transect_plot + plot_layout(guides = 'collect')
```

![plot of chunk htele_covariate](fig-htele_covariate-1.png)

## Spatio-temporal rasters

Extraction of covariates from spatio-temporal raster files are also
supported. The algorithm first extracts spatio-temporal rasters as a
multi-layer SpatRaster in `terra` and creates the Event Route Layer from
all spatio-temporal layers.


```r
cov_sptemp <- fcn_covariate_raster_load("hlwdy")
#> Warning in fcn_check_paths(path, paste("Database", idx)): Database covariates does not exist in
#> M:\Users\uqfcho\Documents\seq-koala-monitoring\working_data/final_covariates_raster

#> Warning in fcn_check_paths(path, paste("Database", idx)): Database covariates does not exist in
#> M:\Users\uqfcho\Documents\seq-koala-monitoring\working_data/final_covariates_raster

#> Warning in fcn_check_paths(path, paste("Database", idx)): Database covariates does not exist in
#> M:\Users\uqfcho\Documents\seq-koala-monitoring\working_data/final_covariates_raster
#> Error: [rast] filename is empty. Provide a valid filename
names(cov_sptemp)
#>  [1] "X199607" "X199707" "X199807" "X199907" "X200007" "X200107" "X200207" "X200307" "X200407" "X200507" "X200607"
#> [12] "X200707" "X200807" "X200907" "X201007" "X201107" "X201207" "X201307" "X201407" "X201507" "X201607" "X201707"
#> [23] "X201807" "X201907"
```

The covariates are extracted as a multi-layer "SpatRaster" (from the
`terra` package) where the names of the raster layers represents the
dates of the raster layer. Where only the year and month of the raster
layers are available, the dates of the raster layers are assumed to be
taken on the 15th of the month. The date of the month is expected to
have a relatively small effect on the covariate extracted.


```r
cov_sptemp_route_table <- fcn_route_table_raster(cov_sptemp, table_sf_2020)
#> Error in .External(structure(list(name = "CppMethod__invoke_notvoid", : NULL value passed as symbol address
```

The covariate value of the route event layer can be matched to the date
of the survey. The covariate value representative of the date which the
transect is surveyed can be interpolated by the following methods:

-   bilinear: bilinear interpolation between the two closest dates of
    the survey date, weighted by how close the survey is to the two
    dates. If the survey date is earlier or later than all of the dates
    of the covariate layers, then the earliest or latest covariate layer
    is selected respectively

-   nearest: the covariate layer closest to the survey date is used

-   "lag1" / "lag2" / "lag3" (work in progress): lagged layers -- select
    the first, second or third layer available earlier than the survey
    date. If the lagged layer is not available, then select the earliest
    layer available.


```r
route_table_date_matched <- fcn_covariate_match_date(cov_sptemp_route_table, names(cov_sptemp), method = 'bilinear')
head(route_table_date_matched)
#>           TransectID       Date  Tlength  X199607  X199707  X199807  X199907  X200007  X200107  X200207  X200307
#> 1 1.0_0_SOL.20210810 2021-08-10 484.1095 161.0010 164.0004 166.0000 165.9999 165.0001 164.0007 164.0014 164.0016
#> 2 1.0_0_SOL.20210810 2021-08-10 484.1095 162.9986 165.9979 166.9977 167.9977 167.9985 168.9987 170.9982 171.9978
#> 3 1.0_0_SOL.20210810 2021-08-10 484.1095 159.0008 160.0012 162.0011 164.0010 166.0005 167.0005 169.0003 170.0000
#> 4 1.0_0_SOL.20210810 2021-08-10 484.1095 159.9996 161.9993 163.9989 165.9986 166.9989 167.9991 168.9992 168.9995
#> 5 1.0_0_SOL.20210810 2021-08-10 484.1095 162.9992 166.9987 167.9992 169.9990 169.9994 170.9994 170.9995 170.9991
#> 6 1.0_0_SOL.20210810 2021-08-10 484.1095 161.9986 163.9982 163.9989 163.9992 163.9996 164.9994 164.9991 164.9987
#>    X200407  X200507  X200607  X200707  X200807  X200907  X201007  X201107  X201207  X201307  X201407  X201507
#> 1 163.0013 163.0002 161.9994 161.9986 162.9982 165.9985 169.9985 171.9987 171.9987 170.9984 167.9984 163.9993
#> 2 168.9984 164.9991 160.9995 157.9998 157.9998 161.9998 166.0000 169.0001 168.9998 167.9985 164.9983 163.9978
#> 3 168.9996 163.9999 158.0004 156.0000 158.9994 166.9987 172.9984 175.9986 173.9991 168.9999 164.0004 161.0008
#> 4 166.9997 163.0006 158.0007 155.0006 157.0003 163.9995 169.9989 173.9987 172.9989 168.9990 164.9992 162.9988
#> 5 167.9992 164.9989 160.9987 158.9988 160.9988 164.9994 170.9996 174.0000 173.9999 170.0001 166.0001 163.0000
#> 6 163.9982 159.9984 155.9990 153.0004 154.0012 158.0020 164.0023 172.0007 175.9989 174.9979 170.9975 163.9986
#>    X201607  X201707  X201807  X201907     FMEAS    TMEAS segment_length   lpercent    value
#> 1 161.0000 161.0004 161.9997 166.9980  39.51914 128.4372       88.91807 0.18367347 166.9980
#> 2 162.9983 163.9985 161.9992 161.9993 128.43721 167.9564       39.51914 0.08163265 161.9993
#> 3 161.0005 163.0001 161.0001 161.0001 167.95635 276.6340      108.67764 0.22448980 161.0001
#> 4 161.9987 162.9983 160.9992 161.0000 276.63400 296.3936       19.75957 0.04081633 161.0000
#> 5 161.9991 162.9989 161.9992 162.9993 296.39357 434.7106      138.31700 0.28571429 162.9993
#> 6 157.0001 151.0025 155.0012 159.0000 434.71056 484.1095       49.39893 0.10204082 159.0000
```

The date matching algorithm creates / overwrites the "value" column in
the route_table as an output. Here we preview the extracted,
interpolated value next to the most recent layer of the spatio-temporal
raster.


```r
cov_sptemp_date_matched <- fcn_locate_feature_from_route(route_table_date_matched, table_sf_2020)
ext <- terra::ext(bbox$xlim[1], bbox$xlim[2], bbox$ylim[1], bbox$ylim[2])
cov_sptemp_crop <- terra::crop(cov_sptemp, ext)
#> Error in .External(structure(list(name = "CppMethod__invoke_notvoid", : NULL value passed as symbol address
limits <- terra::minmax(cov_sptemp_crop)
rast_sptemp_plot <- ggplot() +
  geom_spatraster(data = cov_sptemp_crop, aes(fill = X201907)) +
  do.call(coord_sf, bbox)+
  labs(fill = "") +
  ggtitle("hlwdy: 2019/07 woody \nvegetation cover") +
  scale_fill_viridis_c(limits = c(limits[1], limits[2])) +
  #guides(color = 'none')+
  theme_bw()+
  theme(panel.grid = element_blank())
transect_sptemp_plot <- ggplot() +
  geom_sf(data = cov_sptemp_date_matched, aes(color = value), linewidth = 1) +
  do.call(coord_sf, bbox)+
  ggtitle("hlwdy: transects (bilinear)") +
  labs(color = "") +
  scale_color_viridis_c(limits = c(limits[1], limits[2])) +
  theme_bw()+
  theme(panel.grid = element_blank())
rast_sptemp_plot + transect_sptemp_plot + plot_layout(guides = 'collect')
```

![plot of chunk hlwdy_plot](fig-hlwdy_plot-1.png)
