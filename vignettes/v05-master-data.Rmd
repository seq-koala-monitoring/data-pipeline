---
title: "5. Master data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{5. Master data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
library(SEQKoalaDataPipeline)
```

# Master data

Wrapper functions documented in the "Master data" section are designed to abstract away the details of the smaller functions, such that the most common use-cases of the package can be executed in succinct code.

We begin by extracting all tables as simple features.

```r
data_dir <- "M:\\Users\\uqfcho\\Documents\\seq-koala-monitoring\\working_data"
#data_dir <- "C:\\Users\\uqfcho\\Documents/seq-koala-monitoring/working_data"
fcn_set_home_dir(data_dir)
fcn_set_grid_size(100)
#> class       : SpatRaster 
#> dimensions  : 2467, 1759, 1  (nrow, ncol, nlyr)
#> resolution  : 100, 100  (x, y)
#> extent      : 378280, 554180, 6862464, 7109164  (xmin, xmax, ymin, ymax)
#> coord. ref. : GDA2020 / MGA zone 56 (EPSG:7856) 
#> source(s)   : memory
#> name        :  GridID 
#> min value   :       1 
#> max value   : 2311397
master <- fcn_all_tables_sf()
#> Warning in fcn_keep_distinct(transect_sf): 24 records cannot be uniquely identified with
#> SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct records.
#> Warning in fcn_line_transect_sf_1996(): Line Transect: attribute join incomplete. 
#> Joined uniquely: 376. 
#> Joined at the site level: 169. 
#> Join failed: 0
#> Warning in fcn_keep_distinct(transect_sf, cols = c("SiteNumber", "TransectNumber", : 83 records
#> cannot be uniquely identified with SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct
#> records.
#> Warning in fcn_strip_transect_sf_all(): Strip Transect: attribute join incomplete. 
#> Joined uniquely: 916. 
#> Joined at the site level: 1726. 
#> Join failed: 0
```

The extracted "master" dataframe contains spatial representations of the transects in both linestring formats (single observer line transects from the newer 2020-current database) as well as other spatial representations (strip/ UAoA transects, and some line transects from 1996-2015). The `fcn_mixed_extract_raster` function handles these mixed formats simultaneously. It wraps around functions that use linear referencing approaches to extract grid information from rasters, as well as raster extraction tools, with `exactextractr` that uses C++ as a backend for quick extraction.

The function `fcn_all_transect_grid_fractions` abstracts away from that. In one function call, the algorithm executes the following:

1. Generate spatial grid

2. SQL queries to extract transect-level data

3. Joining with spatial features (if needed) or generate spatial features by coordinates

4. Buffer spatial features (if needed)

5. Calculate weight fractions


```r
transect_grid <- fcn_all_transect_grid_fractions()
#> Warning in fcn_keep_distinct(transect_sf): 24 records cannot be uniquely identified with
#> SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct records.
#> Warning in fcn_line_transect_sf_1996(): Line Transect: attribute join incomplete. 
#> Joined uniquely: 376. 
#> Joined at the site level: 169. 
#> Join failed: 0
#> Warning in fcn_keep_distinct(transect_sf, cols = c("SiteNumber", "TransectNumber", : 83 records
#> cannot be uniquely identified with SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct
#> records.
#> Warning in fcn_strip_transect_sf_all(): Strip Transect: attribute join incomplete. 
#> Joined uniquely: 916. 
#> Joined at the site level: 1726. 
#> Join failed: 0
#>   |                                                                                                  |                                                                                          |   0%  |                                                                                                  |=                                                                                         |   1%  |                                                                                                  |==                                                                                        |   2%  |                                                                                                  |===                                                                                       |   3%  |                                                                                                  |===                                                                                       |   4%  |                                                                                                  |====                                                                                      |   4%  |                                                                                                  |====                                                                                      |   5%  |                                                                                                  |=====                                                                                     |   5%  |                                                                                                  |=====                                                                                     |   6%  |                                                                                                  |======                                                                                    |   7%  |                                                                                                  |=======                                                                                   |   8%  |                                                                                                  |========                                                                                  |   9%  |                                                                                                  |=========                                                                                 |   9%  |                                                                                                  |=========                                                                                 |  10%  |                                                                                                  |==========                                                                                |  11%  |                                                                                                  |===========                                                                               |  12%  |                                                                                                  |============                                                                              |  13%  |                                                                                                  |============                                                                              |  14%  |                                                                                                  |=============                                                                             |  14%  |                                                                                                  |=============                                                                             |  15%  |                                                                                                  |==============                                                                            |  15%  |                                                                                                  |==============                                                                            |  16%  |                                                                                                  |===============                                                                           |  17%  |                                                                                                  |================                                                                          |  18%  |                                                                                                  |=================                                                                         |  18%  |                                                                                                  |=================                                                                         |  19%  |                                                                                                  |==================                                                                        |  20%  |                                                                                                  |===================                                                                       |  21%  |                                                                                                  |====================                                                                      |  22%  |                                                                                                  |=====================                                                                     |  23%  |                                                                                                  |=====================                                                                     |  24%  |                                                                                                  |======================                                                                    |  24%  |                                                                                                  |======================                                                                    |  25%  |                                                                                                  |=======================                                                                   |  25%  |                                                                                                  |=======================                                                                   |  26%  |                                                                                                  |========================                                                                  |  27%  |                                                                                                  |=========================                                                                 |  28%  |                                                                                                  |==========================                                                                |  28%  |                                                                                                  |==========================                                                                |  29%  |                                                                                                  |===========================                                                               |  30%  |                                                                                                  |============================                                                              |  31%  |                                                                                                  |=============================                                                             |  32%  |                                                                                                  |=============================                                                             |  33%  |                                                                                                  |==============================                                                            |  33%  |                                                                                                  |==============================                                                            |  34%  |                                                                                                  |===============================                                                           |  34%  |                                                                                                  |===============================                                                           |  35%  |                                                                                                  |================================                                                          |  36%  |                                                                                                  |=================================                                                         |  37%  |                                                                                                  |==================================                                                        |  37%  |                                                                                                  |==================================                                                        |  38%  |                                                                                                  |===================================                                                       |  38%  |                                                                                                  |===================================                                                       |  39%  |                                                                                                  |====================================                                                      |  40%  |                                                                                                  |=====================================                                                     |  41%  |                                                                                                  |======================================                                                    |  42%  |                                                                                                  |======================================                                                    |  43%  |                                                                                                  |=======================================                                                   |  43%  |                                                                                                  |=======================================                                                   |  44%  |                                                                                                  |========================================                                                  |  44%  |                                                                                                  |========================================                                                  |  45%  |                                                                                                  |=========================================                                                 |  46%  |                                                                                                  |==========================================                                                |  46%  |                                                                                                  |==========================================                                                |  47%  |                                                                                                  |===========================================                                               |  47%  |                                                                                                  |===========================================                                               |  48%  |                                                                                                  |============================================                                              |  49%  |                                                                                                  |=============================================                                             |  50%  |                                                                                                  |==============================================                                            |  51%  |                                                                                                  |===============================================                                           |  52%  |                                                                                                  |===============================================                                           |  53%  |                                                                                                  |================================================                                          |  53%  |                                                                                                  |================================================                                          |  54%  |                                                                                                  |=================================================                                         |  54%  |                                                                                                  |==================================================                                        |  55%  |                                                                                                  |==================================================                                        |  56%  |                                                                                                  |===================================================                                       |  56%  |                                                                                                  |===================================================                                       |  57%  |                                                                                                  |====================================================                                      |  57%  |                                                                                                  |====================================================                                      |  58%  |                                                                                                  |=====================================================                                     |  59%  |                                                                                                  |======================================================                                    |  60%  |                                                                                                  |=======================================================                                   |  61%  |                                                                                                  |=======================================================                                   |  62%  |                                                                                                  |========================================================                                  |  62%  |                                                                                                  |========================================================                                  |  63%  |                                                                                                  |=========================================================                                 |  63%  |                                                                                                  |==========================================================                                |  64%  |                                                                                                  |===========================================================                               |  65%  |                                                                                                  |===========================================================                               |  66%  |                                                                                                  |============================================================                              |  66%  |                                                                                                  |============================================================                              |  67%  |                                                                                                  |=============================================================                             |  67%  |                                                                                                  |=============================================================                             |  68%  |                                                                                                  |==============================================================                            |  69%  |                                                                                                  |===============================================================                           |  70%  |                                                                                                  |================================================================                          |  71%  |                                                                                                  |================================================================                          |  72%  |                                                                                                  |=================================================================                         |  72%  |                                                                                                  |==================================================================                        |  73%  |                                                                                                  |===================================================================                       |  74%  |                                                                                                  |===================================================================                       |  75%  |                                                                                                  |====================================================================                      |  75%  |                                                                                                  |====================================================================                      |  76%  |                                                                                                  |=====================================================================                     |  76%  |                                                                                                  |=====================================================================                     |  77%  |                                                                                                  |======================================================================                    |  78%  |                                                                                                  |=======================================================================                   |  79%  |                                                                                                  |========================================================================                  |  80%  |                                                                                                  |=========================================================================                 |  81%  |                                                                                                  |=========================================================================                 |  82%  |                                                                                                  |==========================================================================                |  82%  |                                                                                                  |===========================================================================               |  83%  |                                                                                                  |============================================================================              |  84%  |                                                                                                  |============================================================================              |  85%  |                                                                                                  |=============================================================================             |  85%  |                                                                                                  |=============================================================================             |  86%  |                                                                                                  |==============================================================================            |  86%  |                                                                                                  |==============================================================================            |  87%  |                                                                                                  |===============================================================================           |  88%  |                                                                                                  |================================================================================          |  89%  |                                                                                                  |=================================================================================         |  90%  |                                                                                                  |=================================================================================         |  91%  |                                                                                                  |==================================================================================        |  91%  |                                                                                                  |===================================================================================       |  92%  |                                                                                                  |====================================================================================      |  93%  |                                                                                                  |=====================================================================================     |  94%  |                                                                                                  |=====================================================================================     |  95%  |                                                                                                  |======================================================================================    |  95%  |                                                                                                  |======================================================================================    |  96%  |                                                                                                  |=======================================================================================   |  96%  |                                                                                                  |=======================================================================================   |  97%  |                                                                                                  |========================================================================================  |  98%  |                                                                                                  |========================================================================================= |  99%  |                                                                                                  |==========================================================================================| 100%
#> Error in (function (..., row.names = NULL, check.rows = FALSE, check.names = TRUE, : arguments imply differing number of rows: 17, 59, 236, 404, 390, 184, 430, 734, 148, 124, 115, 593, 186, 163, 21, 619
```
