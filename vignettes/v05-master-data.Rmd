---
title: "5. Master data"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{5. Master data}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---




```r
library(SEQKoalaDataPipeline)
```

# Master data

Wrapper functions documented in the "Master data" section are designed to abstract away the details of the smaller functions, such that the most common use-cases of the package can be executed in succinct code.

We begin by extracting all tables as simple features.

```r
#data_dir <- "M:\\Users\\uqfcho\\Documents\\seq-koala-monitoring\\working_data"
data_dir <- "C:\\Users\\uqfcho\\Documents/seq-koala-monitoring/working_data"
fcn_set_home_dir(data_dir)
fcn_set_grid_size(100)
#> class       : SpatRaster 
#> dimensions  : 2467, 1759, 1  (nrow, ncol, nlyr)
#> resolution  : 100, 100  (x, y)
#> extent      : 378280, 554180, 6862464, 7109164  (xmin, xmax, ymin, ymax)
#> coord. ref. : GDA2020 / MGA zone 56 (EPSG:7856) 
#> source(s)   : memory
#> name        :  GridID 
#> min value   :       1 
#> max value   : 2311397
master <- fcn_all_tables_sf()
#> Warning in fcn_keep_distinct(transect_sf): 24 records cannot be uniquely identified with
#> SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct records.
#> Warning in fcn_line_transect_sf_1996(): Line Transect: attribute join incomplete. 
#> Joined uniquely: 376. 
#> Joined at the site level: 169. 
#> Join failed: 0
#> Warning in fcn_keep_distinct(transect_sf, cols = c("SiteNumber", "TransectNumber", : 83 records cannot be
#> uniquely identified with SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct records.
#> Warning in fcn_strip_transect_sf_all(): Strip Transect: attribute join incomplete. 
#> Joined uniquely: 916. 
#> Joined at the site level: 1726. 
#> Join failed: 0
```

The extracted "master" dataframe contains spatial representations of the transects in both linestring formats (single observer line transects from the newer 2020-current database) as well as other spatial representations (strip/ UAoA transects, and some line transects from 1996-2015). The `fcn_mixed_extract_raster` function handles these mixed formats simultaneously. It wraps around functions that use linear referencing approaches to extract grid information from rasters, as well as raster extraction tools, with `exactextractr` that uses C++ as a backend for quick extraction.

The function `fcn_all_transect_grid_fractions` abstracts away from that. In one function call, the algorithm executes the following:

1. Generate spatial grid

2. SQL queries to extract transect-level data

3. Joining with spatial features (if needed) or generate spatial features by coordinates

4. Buffer spatial features (if needed)

5. Calculate grid weight fractions - iterating through all buffer values by buffering each polygon and extracting its weights

6. Collating all results into a list format


```r
transect_grid <- fcn_all_transect_grid_fractions(buffer = c(0, 2500))
#> Warning in fcn_keep_distinct(transect_sf): 24 records cannot be uniquely identified with
#> SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct records.
#> Warning in fcn_line_transect_sf_1996(): Line Transect: attribute join incomplete. 
#> Joined uniquely: 376. 
#> Joined at the site level: 169. 
#> Join failed: 0
#> Warning in fcn_keep_distinct(transect_sf, cols = c("SiteNumber", "TransectNumber", : 83 records cannot be
#> uniquely identified with SiteNumber-TransectNumber-SurveyNumber. Keeping only distinct records.
#> Warning in fcn_strip_transect_sf_all(): Strip Transect: attribute join incomplete. 
#> Joined uniquely: 916. 
#> Joined at the site level: 1726. 
#> Join failed: 0
```
The end result is a list containing tables of line transects, strip transect, and all of area transects. The tables are in long format, so each row corresponds to one grid cell that has an overlap with the transect. Each transect is identified uniquely by its TransectID.

Particularly the Line Transect, Strip Transect and UAoA tables contain the "GridID" and "fraction" column that contains the Grid cell that it overlaps with, and the "fraction" columns showing the fraction which the transect overlaps with. Depending on the buffer, the "fraction" is different; here we illustrate a no-buffer (0) and 2.5km (2500) buffer, in the columns 'fraction_0' and 'fraction_2500' respectively.


```r
glimpse(transect_grid)
#> List of 4
#>  $ line_transect :'data.frame':	7255924 obs. of  15 variables:
#>   ..$ db              : chr [1:7255924] "1" "1" "1" "1" ...
#>   ..$ TransectID      : chr [1:7255924] "109.1_1_SOL.20110901" "109.1_1_SOL.20110901" "109.1_1_SOL.20110901" "109.1_1_SOL.20110901" ...
#>   ..$ SiteID          : int [1:7255924] 109 109 109 109 109 109 109 109 109 109 ...
#>   ..$ Date            : POSIXct[1:7255924], format: "2011-09-01" "2011-09-01" "2011-09-01" ...
#>   ..$ TrSiteID        : num [1:7255924] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ Tlength         : num [1:7255924] 278 278 278 278 278 275 275 275 275 275 ...
#>   ..$ Number_Sightings: int [1:7255924] 2 2 2 2 2 0 0 0 0 0 ...
#>   ..$ Number_Observers: num [1:7255924] 2 2 2 2 2 3 3 3 3 3 ...
#>   ..$ Start_Eastings  : num [1:7255924] 495982 495982 495982 495982 495982 ...
#>   ..$ Start_Northings : num [1:7255924] 6984954 6984954 6984954 6984954 6984954 ...
#>   ..$ End_Eastings    : num [1:7255924] 495707 495707 495707 495707 495707 ...
#>   ..$ End_Northings   : num [1:7255924] 6984989 6984989 6984989 6984989 6984989 ...
#>   ..$ GridID          : num [1:7255924] 903602 903601 902646 902645 902644 ...
#>   ..$ fraction_0      : num [1:7255924] 0.0204 0.2653 0.102 0.3469 0.2653 ...
#>   ..$ fraction_2500   : num [1:7255924] 0.000476 0.000476 0.000476 0.000476 0.000476 ...
#>  $ strip_transect:'data.frame':	8080793 obs. of  9 variables:
#>   ..$ TransectID      : chr [1:8080793] "1.1_3_ST.20101116" "1.1_3_ST.20101116" "1.1_3_ST.20101116" "1.1_3_ST.20101116" ...
#>   ..$ SiteID          : int [1:8080793] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ Date            : POSIXct[1:8080793], format: "2010-11-16" "2010-11-16" "2010-11-16" ...
#>   ..$ TArea           : num [1:8080793] 7.45 7.45 7.45 7.45 7.45 ...
#>   ..$ Number_Sightings: int [1:8080793] 0 0 0 0 0 0 0 0 0 0 ...
#>   ..$ Number_Observers: num [1:8080793] 5 5 5 5 5 5 5 5 5 5 ...
#>   ..$ GridID          : num [1:8080793] 1439596 1439597 1439598 1439599 1439600 ...
#>   ..$ fraction_0      : num [1:8080793] 0.00753 0.07986 0.06464 0.04362 0.02261 ...
#>   ..$ fraction_2500   : num [1:8080793] 0.000383 0.000383 0.000383 0.000383 0.000383 ...
#>  $ uaoa          :'data.frame':	327602 obs. of  17 variables:
#>   ..$ SiteNumber      : int [1:327602] 216 216 216 216 216 216 216 216 216 216 ...
#>   ..$ Shape_Length    : num [1:327602] 5725 5725 5725 5725 5725 ...
#>   ..$ Shape_Area      : num [1:327602] 1137144 1137144 1137144 1137144 1137144 ...
#>   ..$ db              : chr [1:327602] "1996-2015" "1996-2015" "1996-2015" "1996-2015" ...
#>   ..$ TransectID      : chr [1:327602] "216.1_99_UAoA.20110417" "216.1_99_UAoA.20110417" "216.1_99_UAoA.20110417" "216.1_99_UAoA.20110417" ...
#>   ..$ SiteID          : int [1:327602] 216 216 216 216 216 216 216 216 216 216 ...
#>   ..$ Date            : POSIXct[1:327602], format: "2011-04-17" "2011-04-17" "2011-04-17" ...
#>   ..$ TArea           : num [1:327602] 114 114 114 114 114 ...
#>   ..$ Number_Sightings: int [1:327602] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ Number_Observers: num [1:327602] NA NA NA NA NA NA NA NA NA NA ...
#>   ..$ TransectNumber  : int [1:327602] 99 99 99 99 99 99 99 99 99 99 ...
#>   ..$ SurveyNumber    : int [1:327602] 21 21 21 21 21 21 21 21 21 21 ...
#>   ..$ SubSurveyNumber : int [1:327602] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ TrSiteID        : num [1:327602] NA NA NA NA NA NA NA NA NA NA ...
#>   ..$ GridID          : num [1:327602] 1372965 1372966 1372967 1372968 1372969 ...
#>   ..$ fraction_0      : num [1:327602] 0.005845 0.005186 0.003696 0.002284 0.000751 ...
#>   ..$ fraction_2500   : num [1:327602] 0.000305 0.000305 0.000305 0.000305 0.000305 ...
#>  $ perp_distance :'data.frame':	2642 obs. of  12 variables:
#>   ..$ db              : chr [1:2642] "1996-2015" "1996-2015" "1996-2015" "1996-2015" ...
#>   ..$ TransectID      : chr [1:2642] "1.1_1_ST.19960213" "1.1_1_ST.19960816" "1.1_1_ST.19970318" "1.1_1_ST.19970818" ...
#>   ..$ SiteID          : int [1:2642] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ Date            : POSIXct[1:2642], format: "1996-02-13" "1996-08-16" "1997-03-18" ...
#>   ..$ TArea           : num [1:2642] 6.74 4.77 2.38 2.38 3.18 ...
#>   ..$ Number_Sightings: int [1:2642] 2 1 0 2 2 2 4 0 1 0 ...
#>   ..$ Number_Observers: num [1:2642] 6 7 4 4 5 6 4 5 5 4 ...
#>   ..$ SiteNumber      : int [1:2642] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ TransectNumber  : int [1:2642] 1 1 1 1 1 10 10 10 10 10 ...
#>   ..$ SurveyNumber    : int [1:2642] 1 2 3 4 7 7 15 18 20 22 ...
#>   ..$ SubSurveyNumber : int [1:2642] 1 1 1 1 1 1 1 1 1 1 ...
#>   ..$ TrSiteID        : num [1:2642] NA NA NA NA NA NA NA NA NA NA ...
```

